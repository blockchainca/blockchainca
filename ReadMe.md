# Block Chain CA

这里是网络安全协议课程大作业

## Team Member
Clt, Lxy

## 一、摘要

在联盟链中实现一个可信第三方证书体系。多个网站组成联盟，可以使得用户在多网站用同一账户上登录。共识机制目前采用的是工作量证明的算法。

## 二、系统模型

在我们的系统模型中有几个角色：

1. node 这里指的是区块链中的节点。这些节点组成了联盟。他们负责提供证书的登记和查询功能。

2. server 是提供服务的对象，client 对普通的用户提供注册和验证的功能，当有收到注册请求的时候，将会为用户代理办理证书的业务。对用户提供注册、登录的功能。

3. client 普通的用户，与 server 直接交互。

对于某一个实体来说，可以即承担 node 的功能，又承担 server 的功能。

### 2.1 Node 角色

我们考虑联盟链中的节点一般是固定的，或者是变化幅度并不大。节点之前主要有如下几个功能：

1. 对 server 提供查询的功能，server 可以通过指定的序列号、手机号等来查询证书是否存在，如果存在则返回证书。

2. 响应 server 提出的注册证书以及证书状态变更的请求。对证书打包后发送到区块链上。

3. 响应其他 node 节点的请求，包括要求发送之前的区块（merkle 树哈希错误、前一个区块哈希不正确、发现更长的链、加入网路时）。这里的行为是广播请求，并合并最长的区块链。

4. 挖矿、对已缓存的证书进行工作量证明。当某一个区块挖出来后，全网广播。

5. 接受到其他节点产生的新的区块时，更新自己的状态信息

我们搭建了一个三个节点的分布式网络。分别由 runs1.py, runs2.py, runs3.py 启动。其配置文件位于 config/nodex.json 中。这个配置文件主要包括，创世区块的信息、伙伴节点的ip和自己的ip。

节点的公私钥位于 keys 文件夹中。区块信息将写在 data 文件夹的对于文件中。

### 2.2 Server 角色

Server 角色的主要功能是：

1. 向某一个 node 查询有关证书的信息

2. 有新增证书、修改和删除证书时候，需要将消息广播给联盟链（为了节省开销，不再由某一个 node 发起广播）

3. 对用户提供注册和登录功能，必要时对用户实体进行验证（验证码等）

我们实现了一个 server 由 runc1.py 启动。它的主要功能是向网络发起申请证书和查询证书的请求。（其他功能需要完善）。非对称秘钥也在 keys 中。

### 2.3 client 角色

主要是与 server 交互。

## 三、模型实现

### 3.1 网络层

网络层的主要任务是构建不同节点间的通信，并以此构建一个分布式网络环境。在此基础之上，能够有限度的容忍节点的加入和退出。

为了减小通信开销，节点间的通信没有采用 http 或者 rpc 的有关协议，而是直接使用了 tcp 协议。每一个 node 都将允许只是两个线程，其中一个用于监听网络请求。我们的 tcp 包内容主要是 json 格式：

``` json
{
    'url': 'add',
    'data': [{'1'}] // 例子
}
```
服务进程将解析 url 的内容，并将 data 交由不同的 handle 函数处理，以此实现类似 rpc 的功能。

### 3.2 区块链层

区块链层的主要实现了区块链相关的主要逻辑。其中的区块链中的 data 部分并没有指定其上层应用的具体细节，而只是定义了一部分与上次的一些接口。

### 3.3 应用层

应用层实现了证书、撤销链的存储和查询。证书的具体存储的格式定义在 Certificate.py 中。

## 四、interaction


## License

Copyright 2019 Lxy,Clt

参见 LICENSE 文件。